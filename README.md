# Веб-приложение для управления ТСЖ

Мини‑система для коммуникации жильцов с председателем ТСЖ: жильцы подают
заявки, передают показания счётчиков, председатель управляет их статусами и
выставляет счета.

## Технологии

- **Backend:** PHP 8.2 (нативный, без фреймворков)
- **Database:** PostgreSQL (ранее SQLite, теперь в контейнере `db`)
- **Frontend:** HTML5, CSS3, Vanilla JS
- **Инфраструктура:** Docker, Docker Compose, Nginx, PHP‑FPM

## Возможности

✅ Регистрация и верификация через Email  
✅ Роли пользователей (Жилец / Председатель ТСЖ)  
✅ Создание и управление заявками на ремонт  
✅ Система статусов заявок (новая, в работе, выполнена, отклонена)  
✅ Защита от CSRF атак  
✅ Хеширование паролей через bcrypt  

## Быстрый старт

### Требования

- Docker & Docker Compose (3.8+)
- Git (для клонирования)

### Установка и запуск

```bash
# Клонировать репозиторий
git clone https://github.com/Omichpolyebok/sited.git
cd sited/sited      

# Построить образы и запустить стек
docker compose up -d --build
```

На Windows всё запускается под WSL2, порт уже проброшен на локальный хост.
Поэтому приложение доступно по `http://127.0.0.1:8080` или если вы настроите
`hosts` — через свой домен (например `mysite.local`).

> ⚠️ если вы ранее монтировали `./vendor` как том, убедитесь, что в
> `docker-compose.yml` используется `vendor_data` volume или что локальная
> папка содержит зависимости (см. ниже).

### Отключение проверки и почты (для разработки)

Для упрощённого тестирования можно пропустить Cloudflare Turnstile (капчу)
и отправку писем. Просто задайте переменные окружения:

```yaml
services:
  app:
    environment:
      - DISABLE_TURNSTILE=1
      - DISABLE_EMAIL=1
```

Либо добавьте их в `.env` (пример ниже).

### Администратор по умолчанию

| Роль  | Email            | Пароль |
|-------|------------------|--------|
| Админ | admin@yandex.ru  | admin  |

После первого запуска можно зарегистрировать других пользователей или
изменить запись в базе.

## Структура проекта

```
.sited/                  # рабочая папка репозитория
├── docker/              # Конфигурация Nginx
│   └── nginx/conf.d/
├── public/              # фронтенд и PHP‑страницы (index.php, login.php и т.д.)
├── src/                 # серверная логика
│   ├── config.php       # настройки (SMTP, прочие переменные)
│   ├── db.php           # подключение к PostgreSQL через PDO
│   └── mail.php         # обёртка на PHPMailer
├── inc/                 # include‑файлы (header, init)
├── db/                  # схемы для БД
│   └── schema.sql       # PostgreSQL схема (инициализация через volume)
├── .docker/             # вспомогательные скрипты для образа
│   └── init_db.php      # удалённая инициализация (используется старой версией образа, можно игнорировать)
├── docker-compose.yml   # стек (app, web, db)
├── Dockerfile           # PHP‑образ (composer, pdo_pgsql и т.д.)
├── entrypoint.sh        # права/инициализация
├── README.md            # этот файл
└── vendor_data/         # Docker volume для зависимостей
```

## Настройка SMTP (Email)

Письма отправляются через PHPMailer, конфигурация находится в `src/config.php`.
Если вы тестируете локально и не хотите рассылать почту, просто включите
`DISABLE_EMAIL=1` (см. раздел выше).

```php
return [
    'smtp_host'   => 'smtp.yandex.ru',       // SMTP хост
    'smtp_user'   => 'your-email@yandex.ru', // логин
    'smtp_pass'   => 'app-password',         // пароль приложения
    'smtp_port'   => 465,                    // 465 для SSL, 587 для TLS
    'from_email'  => 'your-email@yandex.ru',
    'from_name'   => 'ТСЖ Система',
];
```


## Управление контейнерами

```bash
# Запустить/пересоздать (при изменении Dockerfile или зависимостей)
docker compose up -d --build

# Остановить и удалить (удаляет тома db и vendor)
docker compose down -v

# Только остановить
docker compose stop

# Просмотр логов приложения
docker compose logs -f app

docker compose logs -f web    # nginx

docker compose logs -f db     # postgres
```


## Учетные данные по умолчанию

| Роль  | Email           | Пароль |
|-------|-----------------|--------|
| Админ | admin@yandex.ru | admin  |

Чтобы добавить следующее окружение пользователя, можете выполнить
SQL-запрос прямо в контейнере PostgreSQL или использовать веб‑форму
(регистрация + код подтверждения).

> **⚠️ Обязательно смените пароль администратора в продакшне!**

## Разработка

Все файлы синхронизируются с хостом через volume. Изменения видны сразу без пересборки контейнера.

```bash
# Перезагрузить PHP после изменений (если нужно)
docker exec mysite_php kill -USR2 1
```

## Проблемы и решения

### БД работает в режиме readonly

Решение: `entrypoint.sh` автоматически исправляет права доступа при запуске контейнера.

### Письма не отправляются

1. Проверьте параметры SMTP в `src/config.php`
2. Посмотрите логи: `docker logs mysite_php | grep -i mail`
3. Убедитесь, что пароль приложения верный (не основной пароль от почты)

## Лицензия

MIT

